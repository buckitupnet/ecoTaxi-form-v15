# Документация по модулям


1. [Подробнее о модуле Enigma](#модуль-enigma)
2. [Подробнее о модуле EncryptionManager](#модуль-encryptionmanager)
3. [Подробнее о модуле EcoTaxi](#модуль-ecotaxi)


## Модуль Enigma

Модуль **Enigma** предоставляет набор криптографических утилит для хеширования, шифрования и управления ключами. Он использует
библиотеки `@noble/secp256k1` для эллиптической криптографии, `blowfish` для шифрования данных и `jsSHA` для хеширования. Модуль
разработан для выполнения безопасных операций с данными, таких как шифрование, дешифрование, вычисление общего секрета и управление
ключевыми парами с использованием современных алгоритмов.

---

### Назначение

Модуль **Enigma** предназначен для безопасной обработки данных, включая:

- Хеширование данных с использованием SHA3-256.
- Шифрование и дешифрование данных с использованием Blowfish в режиме CFB.
- Генерацию и управление криптографическими ключевыми парами для ECDH.
- Вычисление общего секрета и его использование для безопасной передачи данных.
- Предоставление утилит для кодирования и декодирования данных.

---

### Методы

#### `hash(base64Data)`

Хеширует данные с использованием алгоритма SHA3-256.

- **Параметры**:
   - `base64Data` (`string`): Входные данные в формате Base64.
- **Возвращает**: `string` - Хешированные данные в формате Base64.

---

#### `encryptData(base64PlainData, base64Password)`

Шифрует данные с использованием Blowfish в режиме CFB.

- **Параметры**:
   - `base64PlainData` (`string`): Открытые данные в формате Base64.
   - `base64Password` (`string`): Пароль в формате Base64.
- **Возвращает**: `string` - Зашифрованные данные в формате Base64.

---

#### `decryptData(base64CipheredData, base64Password)`

Дешифрует данные, зашифрованные с использованием Blowfish в режиме CFB.

- **Параметры**:
   - `base64CipheredData` (`string`): Зашифрованные данные в формате Base64.
   - `base64Password` (`string`): Пароль в формате Base64.
- **Возвращает**: `string` - Расшифрованные данные в формате Base64.

---

#### `generateKeypair()`

Генерирует криптографическую пару ключей для ECDH.

- **Возвращает**: `Object`
   - `publicKey` (`string`): Публичный ключ в формате Base64.
   - `privateKey` (`string`): Приватный ключ в формате Base64.

---

#### `computeSharedSecret(base64PrivateKey, base64PublicKey)`

Вычисляет общий секрет с использованием алгоритма ECDH.

- **Параметры**:
   - `base64PrivateKey` (`string`): Приватный ключ в формате Base64.
   - `base64PublicKey` (`string`): Публичный ключ в формате Base64.
- **Возвращает**: `string` - Общий секрет в формате Base64.

---

#### `encryptWithSharedSecret(base64PlainData, base64PrivateKey, base64PublicKey)`

Шифрует данные с использованием общего секрета, полученного из ECDH.

- **Параметры**:
   - `base64PlainData` (`string`): Открытые данные в формате Base64.
   - `base64PrivateKey` (`string`): Приватный ключ в формате Base64.
   - `base64PublicKey` (`string`): Публичный ключ в формате Base64.
- **Возвращает**: `string` - Зашифрованные данные в формате Base64.

---

#### `shortcodeFromFullKey(base64FullKey)`

Создает короткий код из полного ключа.

- **Параметры**:
   - `base64FullKey` (`string`): Полный ключ в формате Base64.
- **Возвращает**: `string` - Короткий код в шестнадцатеричном формате.

---

#### `convertPublicKeyToHex(publicKeyBase64)`

Преобразует публичный ключ из формата Base64 в формат Hex.

- **Параметры**:
   - `publicKeyBase64` (`string`): Публичный ключ в формате Base64.
- **Возвращает**: `string` - Публичный ключ в формате Hex.

---

#### `convertPrivateKeyToHex(privateKeyBase64)`

Преобразует приватный ключ из формата Base64 в формат Hex.

- **Параметры**:
   - `privateKeyBase64` (`string`): Приватный ключ в формате Base64.
- **Возвращает**: `string` - Приватный ключ в формате Hex.

### Приватные методы

#### `#deriveKeyAndIV(base64Password)`

Генерирует ключ и вектор инициализации (IV) из пароля.

- **Параметры**:
   - `base64Password` (`string`): Пароль в формате Base64.
- **Возвращает**: `Object`
   - `pass` (`Buffer`): Сгенерированный ключ.
   - `iv` (`Buffer`): Вектор инициализации.

---

#### `#blowfishCFB(data, key, iv, decrypt)`

Реализует шифрование/дешифрование Blowfish в режиме CFB.

- **Параметры**:
   - `data` (`Buffer`): Данные для обработки.
   - `key` (`Buffer`): Ключ для Blowfish.
   - `iv` (`Buffer`): Вектор инициализации.
   - `decrypt` (`boolean`): Указывает, нужно ли дешифрование.
- **Возвращает**: `Buffer` - Обработанные данные.

---

### Утилиты

#### `base64ToString(base64Data)`

Конвертирует данные Base64 в строку.

- **Параметры**:
   - `base64Data` (`string`): Данные в формате Base64.
- **Возвращает**: `string` - Декодированная строка.

---

#### `base64ToArray(base64Data)`

Конвертирует данные Base64 в `Uint8Array`.

- **Параметры**:
   - `base64Data` (`string`): Данные в формате Base64.
- **Возвращает**: `Uint8Array` - Массив байтов.

---

#### `arrayToBase64(array)`

Конвертирует `Uint8Array` в формат Base64.

- **Параметры**:
   - `array` (`Uint8Array`): Массив байтов.
- **Возвращает**: `string` - Данные в формате Base64.

---

#### `stringToBase64(string)`

Конвертирует строку в формат Base64.

- **Параметры**:
   - `string` (`string`): Входная строка.
- **Возвращает**: `string` - Данные в формате Base64.

---

### Зависимости

Модуль использует:

- **`@noble/secp256k1`**: Для эллиптической криптографии.
- **`blowfish`**: Для шифрования Blowfish.
- **`jsSHA`**: Для хеширования SHA3-256.
- **`Buffer`**: Для работы с бинарными данными.

## Модуль EncryptionManager

Модуль **EncryptionManager** представляет собой класс для управления шифрованием данных и их безопасным хранением в локальном
хранилище. Реализует паттерн Singleton для обеспечения единственного экземпляра, что делает его удобным для использования в
приложениях, требующих централизованного управления хранилищем и шифрованием.

---

### Назначение

**EncryptionManager** предназначен для:

- Управления локальным хранилищем данных с использованием библиотеки `@lo-fi/local-vault`.
- Шифрования и расшифровки данных c использование passkey.
- Безопасного хранения и извлечения данных с использованием идентификаторов хранилища.
- Инициализации, очистки и проверки состояния хранилища.
- Обработки ошибок и отмены операций.

---

### Основные возможности

- **Поддержка единственного экземпляра**: Класс реализует паттерн Singleton, позволяя создавать единственный экземпляр для всего
  приложения.
- **Инициализация хранилища**: Возможность создания нового или подключения к существующему хранилищу.
- **Шифрование и безопасное хранение данных**: Данные шифруются перед записью и расшифровываются при чтении.
- **Управление идентификаторами хранилища**: Удобный интерфейс для работы с ID хранилища.
- **Отмена операций**: Возможность отмены текущих операций через `AbortController`.

---

### Методы

#### `EncryptionManager.getInstance()`

Возвращает единственный экземпляр класса EncryptionManager.

- **Возвращает**: `EncryptionManager` - Экземпляр класса.

---

#### `initialize()`

Инициализирует хранилище, подключаясь к существующему или создавая новое.

- **Возвращает**: `Promise<void>`

---

#### `createVault()`

Создает новое хранилище и сохраняет его ID.

- **Возвращает**: `Promise<void>`

---

#### `connectToVault(vaultID)`

Подключается к существующему хранилищу по его ID.

- **Параметры**:
   - `vaultID` (`string`): Идентификатор хранилища.
- **Возвращает**: `Promise<void>`

---

#### `setData(value)`

Сохраняет данные в хранилище.

- **Параметры**:
   - `value` (`any`): Данные для сохранения.
- **Возвращает**: `Promise<void>`

---

#### `getData()`

Получает данные из хранилища.

- **Возвращает**: `Promise<any>` - Полученные данные.

---

#### `hasVault()`

Проверяет наличие хранилища.

- **Возвращает**: `Promise<boolean>` - `true`, если хранилище существует, иначе `false`.

---

#### `clearVault()`

Очищает хранилище и удаляет его ID.

- **Возвращает**: `Promise<void>`

---

#### `getVaultID()`

Получает ID хранилища из необработанного хранилища.

- **Возвращает**: `Promise<string|null>` - ID хранилища или `null`, если не найден.

---

#### `saveVaultID(id)`

Сохраняет ID хранилища в необработанное хранилище.

- **Параметры**:
   - `id` (`string`): ID хранилища.
- **Возвращает**: `Promise<void>`

---

#### `removeVaultID()`

Удаляет ID хранилища из необработанного хранилища.

- **Возвращает**: `Promise<void>`

---

#### `ensureVault()`

Проверяет и инициализирует хранилище, если оно не было инициализировано.

- **Возвращает**: `Promise<void>`

---

#### `handleError(error, message)`

Обрабатывает ошибки, возникающие при операциях с хранилищем.

- **Параметры**:
   - `error` (`Error`): Объект ошибки.
   - `message` (`string`): Сообщение для отображения.
- **Возвращает**: `Promise<void>`

---

#### `isCancelError(error)`

Проверяет, является ли ошибка результатом отмены операции.

- **Параметры**:
   - `error` (`Error`): Объект ошибки.
- **Возвращает**: `boolean` - `true`, если операция была отменена, иначе `false`.

---

#### `cancelOperation(reason)`

Отменяет текущую операцию с заданной причиной.

- **Параметры**:
   - `reason` (`string`, необязательный): Причина отмены операции (по умолчанию: `"Операция отменена"`).
- **Возвращает**: `void`

---

### Приватные свойства

- `#vault`: Объект текущего хранилища.
- `#isAuth`: Флаг состояния авторизации.
- `#rawStore`: Объект необработанного хранилища для работы с ID.
- `#abortController`: Контроллер для отмены текущих операций.

---

### Зависимости

Модуль использует:

- **`@lo-fi/local-vault`**: Для работы с локальным зашифрованным хранилищем.
- **`AbortController`**: Для управления отменой операций.

## Модуль EcoTaxi

Класс **EcoTaxi** обеспечивает взаимодействие с сервером EcoTaxi для управления пользовательскими данными, обработки сообщений и работы
с ключами пользователей. Он использует криптографический модуль **Enigma** для генерации и управления ключами, а также для обеспечения
безопасности данных.

---

### Назначение

**EcoTaxi** предназначен для:

- Управления учетными данными пользователей.
- Создания и обработки криптографических ключей.
- Взаимодействия с сервером EcoTaxi через GraphQL API.
- Отправки и получения сообщений между пользователями.
- Генерации уникальных ссылок для пользователей.

---

### Основные возможности

- **Генерация и управление ключами**: Поддержка создания пар ключей и их объединение для хранения.
- **Отправка и получение сообщений**: Удобный интерфейс для общения между пользователями.
- **Интеграция с GraphQL API**: Легкое взаимодействие с сервером для выполнения операций.
- **Поддержка пользовательских ссылок**: Генерация уникальных ссылок на основе публичного ключа.

---

### Методы

#### `constructor(baseUrl)`

Создает экземпляр класса **EcoTaxi**.

- **Параметры**:
   - `baseUrl` (`string`): Базовый URL сервера EcoTaxi.

---

#### `packUserStorage(name, keypair, rooms = [], contacts = {})`

Упаковывает пользовательские данные для хранения.

- **Параметры**:
   - `name` (`string`): Имя пользователя.
   - `keypair` (`Object`): Пара ключей пользователя.
   - `rooms` (`Array`, необязательный): Список комнат (по умолчанию пустой массив).
   - `contacts` (`Object`, необязательный): Список контактов (по умолчанию пустой объект).
- **Возвращает**: `Array` - Упакованные данные пользователя.

---

#### `generateUserKeypair()`

Генерирует новую пару ключей пользователя.

- **Возвращает**: `Object` - Пара ключей пользователя (публичный и приватный ключи в формате Base64).

---

#### `buildUserLink(keypair)`

Создает ссылку пользователя на основе его публичного ключа.

- **Параметры**:
   - `keypair` (`Object`): Пара ключей пользователя.
- **Возвращает**: `string` - Полная ссылка на пользователя.

---

#### `registerUser(name, keypair)`

Регистрирует пользователя на сервере EcoTaxi.

- **Параметры**:
   - `name` (`string`): Имя пользователя.
   - `keypair` (`Object`): Пара ключей пользователя.
- **Возвращает**: `Promise<Object>` - Ответ от сервера.

---

#### `sendMessage(myKeyPair, peerPublicKeyHex, text)`

Отправляет сообщение другому пользователю.

- **Параметры**:
   - `myKeyPair` (`Object`): Пара ключей отправителя.
   - `peerPublicKeyHex` (`string`): Публичный ключ получателя в формате hex.
   - `text` (`string`): Текст сообщения.
- **Возвращает**: `Promise<Object>` - Ответ от сервера.

---

#### `getMessages(myKeyPair, peerPublicKeyHex, amount, beforeIndex)`

Получает сообщения из чата с другим пользователем.

- **Параметры**:
   - `myKeyPair` (`Object`): Пара ключей пользователя.
   - `peerPublicKeyHex` (`string`): Публичный ключ собеседника в формате hex.
   - `amount` (`number`): Количество сообщений для получения.
   - `beforeIndex` (`number`): Индекс сообщения, до которого нужно получить сообщения.
- **Возвращает**: `Promise<Array>` - Список сообщений.

---

### Приватные методы и утилиты

#### `#graphqlRequest(graphql)`

Выполняет GraphQL-запрос к серверу EcoTaxi.

- **Параметры**:
   - `graphql` (`Object`): Объект с запросом GraphQL.
- **Возвращает**: `Promise<Object>` - Ответ от сервера.

---

#### `combineKeypair(keypair)`

Объединяет приватный и публичный ключи в один.

- **Параметры**:
   - `keypair` (`Object`): Пара ключей.
- **Возвращает**: `string` - Объединенный ключ в формате Base64.

---

#### `publicKeyToHex(publicKeyBase64)`

Преобразует публичный ключ из формата Base64 в формат Hex. Это полезно для использования публичного ключа в системах или API, которые
требуют представления ключа в формате Hex.

- **Параметры**:
   - `publicKeyBase64` (`string`): Публичный ключ в формате Base64.
- **Возвращает**: `string` - Публичный ключ в формате Hex.

---

#### `privateKeyToHex(privateKeyBase64)`

Преобразует приватный ключ из формата Base64 в формат Hex. Это полезно для обработки приватных ключей в Hex-совместимых системах,
обеспечивая поддержку гибкости в форматах хранения и передачи данных.

- **Параметры**:
   - `privateKeyBase64` (`string`): Приватный ключ в формате Base64.
- **Возвращает**: `string` - Приватный ключ в формате Hex.

---

### Зависимости

Модуль использует:

- **`Enigma`**: Для генерации ключей и управления криптографическими операциями.
